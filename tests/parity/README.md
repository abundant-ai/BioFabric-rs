# BioFabric-rs Parity Tests

Byte-level parity tests comparing `biofabric-rs` output against golden files
generated by the original Java BioFabric.

## How it works

```
  Input network (.sif/.gw)  ─┐
  + optional config          │
  + optional alignment       │
         ├──► Java BioFabric (Docker) ──► golden .noa, .eda, .bif, .scores
         │
         └──► biofabric-rs (Rust)     ──► output .noa, .eda, .bif, .scores
                                               │
                                         byte-for-byte diff
```

Golden files are generated by running the original Java BioFabric headlessly
inside Docker. The Rust implementation must produce identical output for each
test case.

## Generating goldens

Golden files must exist before running tests. They are pre-generated
reference outputs from the original Java BioFabric and are stored under
`tests/parity/goldens/`.

## Running tests

```bash
cargo test --test parity_tests -- --include-ignored        # layout parity + property tests
cargo test --test analysis_tests -- --include-ignored      # graph analysis + alignment scoring
cargo test --test cli_tests                                # CLI integration tests
```

Each parity test macro generates **three** independent test functions (one per
output format (NOA, EDA, BIF)) so progress can be tracked incrementally.

## Output formats

| File | Format | What it validates |
|------|--------|-------------------|
| `output.noa` | `Node Row\nname = row\n...` | Node ordering |
| `output.eda` | `Link Column\nname (rel) name = col\n...` | Edge layout |
| `output.bif` | Full XML session | Complete session state (colors, columns, annotations, etc.) |
| `output.scores` | `metric\tvalue` (tab-separated) | Alignment quality metrics |

## Test suite summary

| Test file | Tests | Coverage |
|-----------|-------|----------|
| `parity_tests.rs` | 266 | Layout algorithms, shadow links, link grouping, XML round-trip, display options, alignment views |
| `analysis_tests.rs` | 65 | Graph analysis (cycles, components, degree, Jaccard), alignment scoring |
| `cli_tests.rs` | 54 | End-to-end CLI subcommand behavior |
| **Total** | **385** | |

## Test input files

### SIF networks (17 files)

| File | Nodes | Edges | Purpose |
|------|-------|-------|---------|
| `single_node.sif` | 1 | 0 | Minimal — single isolated node |
| `single_edge.sif` | 2 | 1 | Minimal connected network |
| `triangle.sif` | 3 | 3 | Simplest cycle; baseline |
| `self_loop.sif` | 3 | 3 | Feedback edge `A pp A` |
| `isolated_nodes.sif` | 6 | 2 | Lone nodes appended at end |
| `disconnected_components.sif` | 11 | 8 | 4 disconnected components |
| `multi_relation.sif` | 5 | 6 | 3 relation types (pp, pd, gi) |
| `dense_clique.sif` | 6 | 15 | K6 complete graph |
| `linear_chain.sif` | 10 | 9 | Path graph |
| `dag_simple.sif` | 5 | 5 | Simple DAG |
| `dag_diamond.sif` | 4 | 4 | Diamond DAG — converging paths |
| `dag_deep.sif` | 8 | 7 | Linear DAG — many levels |
| `bipartite.sif` | 6 | 6 | Bipartite graph |
| `align_net1.sif` | 3 | 3 | Toy alignment network 1 |
| `align_net2.sif` | 3 | 2 | Toy alignment network 2 |
| `Yeast2KReduced.sif` | ~2.4K | ~16K | Realistic PPI (DesaiEtAl-2019) |
| `SC.sif` | ~6.6K | ~77K | Realistic PPI (DesaiEtAl-2019) |

### GW networks (4 files)

| File | Nodes | Edges | Purpose |
|------|-------|-------|---------|
| `triangle.gw` | 3 | 3 | GW format, undirected |
| `directed_triangle.gw` | 3 | 3 | Directed GW with named relations |
| `CaseStudy-IV-SmallYeast.gw` | 1004 | ~8.3K | Alignment source (DesaiEtAl-2019) |
| `CaseStudy-IV-LargeYeast.gw` | 1004 | ~10K | Alignment target (DesaiEtAl-2019) |

### Alignment files (5 files)

| File | Mappings | Description |
|------|----------|-------------|
| `test_perfect.align` | 3 | Toy: full 1:1 mapping |
| `test_partial.align` | 2 | Toy: incomplete mapping |
| `casestudy_iv.align` | 1004 | Case Study IV: SmallYeast ↔ LargeYeast |
| `yeast_sc_perfect.align` | 2379 | Known ground-truth alignment |
| `yeast_sc_s3_pure.align` | 2379 | Pure structural objective |

### BIF files for round-trip testing (5 files)

| File | Source | Contents |
|------|--------|----------|
| `CaseStudy-III-Perfect.bif` | DesaiEtAl-2019 | Full session with annotations |
| `CaseStudy-III-All-S3.bif` | DesaiEtAl-2019 | Full session with annotations |
| `CaseStudy-III-All-Importance.bif` | DesaiEtAl-2019 | Full session with annotations |
| `CaseStudy-III-P05S3.bif` | DesaiEtAl-2019 | Full session with annotations |
| `CaseStudy-IV.bif` | DesaiEtAl-2019 | Full session with cycle annotations |

### Other input files (4 files)

| File | Format | Purpose |
|------|--------|---------|
| `multi_relation_clusters.na` | Node attribute | Cluster assignments |
| `triangle_reversed.noa` | Node order | Fixed node ordering (reversed) |
| `multi_relation_shuffled.noa` | Node order | Fixed node ordering (shuffled) |
| `triangle_reversed.eda` | Edge order | Fixed edge ordering (reversed) |

## Running specific test subsets

```bash
# By network name
cargo test --test parity_tests -- --include-ignored triangle

# By output format
cargo test --test parity_tests -- --include-ignored noa
cargo test --test parity_tests -- --include-ignored eda
cargo test --test parity_tests -- --include-ignored bif

# By test category
cargo test --test parity_tests -- --include-ignored noshadow        # shadows OFF
cargo test --test parity_tests -- --include-ignored similarity      # similarity layout
cargo test --test parity_tests -- --include-ignored hierdag         # hierarchical DAG
cargo test --test parity_tests -- --include-ignored cluster         # cluster layout
cargo test --test parity_tests -- --include-ignored controltop      # control-top
cargo test --test parity_tests -- --include-ignored set_            # set layout
cargo test --test parity_tests -- --include-ignored roundtrip       # XML round-trip
cargo test --test parity_tests -- --include-ignored align           # alignment tests
cargo test --test parity_tests -- --include-ignored display         # display options
cargo test --test parity_tests -- --include-ignored extract         # subnetwork extraction
cargo test --test parity_tests -- --include-ignored fixed           # fixed-order import

# Analysis tests
cargo test --test analysis_tests -- --include-ignored cycle         # cycle detection
cargo test --test analysis_tests -- --include-ignored jaccard       # Jaccard similarity
cargo test --test analysis_tests -- --include-ignored components    # connected components
cargo test --test analysis_tests -- --include-ignored toposort      # topological sort
cargo test --test analysis_tests -- --include-ignored degree        # node degree
cargo test --test analysis_tests -- --include-ignored align_score   # alignment scoring

# CLI tests
cargo test --test cli_tests
```

## Alignment test data

Realistic alignment test data from:

> Desai et al. (2019) "Network Alignment Visualization"
> BMC Bioinformatics. DOI: 10.1186/s12859-019-2878-3

- **Case Study IV**: SmallYeast <-> LargeYeast (1004 nodes, GW format)
- **Case Studies I-III**: Yeast2KReduced <-> SC (2379/6600 nodes, SIF format)
